<!-- markdownlint-disable -->

# Bloco B - SecretsManager e SSM

## Resumo Aulas

### Aula 1 - Explorando SSM, KMS e Secrets Manager

Nesta aula, exploramos o ecossistema da AWS, com foco no Secret Manager, além de mencionar o Systems Manager e o KMS. O Secret Manager é essencial para gerenciar segredos e suas rotações, especialmente em serviços como RDS e DocumentDB. Discutimos também o KMS, que lida com chaves de criptografia, e o Systems Manager, que armazena configurações simples. Vamos configurar o Secret Manager e o Parameter Store em uma aplicação, preparando o terreno para automatizações futuras.

### Aula 2 - Configurando o SSM

Nesta aula, vamos configurar o Parameter Store da AWS e, em seguida, abordaremos o Secret Manager. Começamos instalando a biblioteca SSM e configurando o cliente AWS SDK. Mostro como criar e acessar parâmetros, tanto seguros quanto padrões, e explico a diferença entre eles. Também discutimos a importância do KMS para a decriptação de dados. Na próxima aula, vamos explorar como usar o KMS para acessar informações criptografadas.

### Aula 3 - Rápido Overview sobre o KMS

Nesta aula, exploramos a implementação do KMS para entender a recuperação de informações encriptadas. Discutimos duas abordagens: uma simples, usando a chave diretamente, e outra mais técnica, utilizando o KMS. Mostrei como configurar o cliente KMS e realizar a decriptação, além de abordar a criação de chaves simétricas e assimétricas. Também falamos sobre permissões e a importância de gerenciar chaves. Por fim, introduzimos o Secret Manager, que será o foco da próxima aula.

### Aula 4 - Configurando o Secrets Manager

Nesta aula, vamos mergulhar no Secret Manager da AWS e entender como ele funciona na prática. Começamos instalando a biblioteca específica para o Secret Manager e configurando o cliente. Em seguida, criamos uma secret na AWS, discutindo boas práticas para nomeação e organização. Mostramos como recuperar informações de forma dinâmica, destacando a importância da rotação de segredos. Por fim, falamos sobre a integração com Kubernetes e como gerenciar chaves de forma eficiente.

## Transcrições

### Aula 1 - Explorando SSM, KMS e Secrets Manager

é sensacional agora que nós passamos ali pela parte produtora do volte nós vamos falar um pouquinho sobre o ecossistema da AWS um foco maior aqui no Secret Manager só que nós temos aqui na verdade os detalhes que são bem importantes né então já tô inclusive logado aqui no meu console da AWS inclusive também já estou com a minha credencial devidamente configurado então fiz aqui aquela configuração clássica você sei que o security credentials e também gerei ali uma chave e fiz a configuração aqui em ambiente local para que eu consiga ter acesso ao console ali da AWS considerando ali a execução de uma aplicação então fica sempre essa dica é importante também rodar esses comandos e caso você esteja acompanhando ali vendo vendo por outra cloud, vai ser algo mais ou menos na mesma linha, mas claro aqui o foco maior é na AWS. Show? Então aqui nós temos o Secret Manager, certo? Eu vou até abrir ele aqui em outra guia. Só que nós temos também outros dois serviços que são muito importantes da gente citar aqui, que é justamente o Systems Manager, ok? E nós temos também o KMS, que é o Key Management Service, ok? Então eu vou deixar aqui os três abertos e nós vamos basicamente passar por cada um deles no contexto teórico e depois nós vamos aprofundar a priori no Secret Manager, ok? Então qual que é a ideia? Ambos ali, os três, eles fazem parte aqui de serviços voltados para Security, Identity e Compliance. Então, o System Manager aqui é um pouquinho mais amplo, então ele tem outras opções também, mas basicamente eles estão focados ali para a gente conseguir, de fato, gerenciar informações sensíveis, porém no contexto da AWS. Então, obviamente, todos aqui são serviços pagos. porém no contexto da AWS. Então, obviamente, todos aqui são serviços pagos, beleza? Diferente do que nós vimos ali no Vault, que também tem a opção paga, mas nós exploramos ali a opção gratuita. Aqui nós estamos falando full de opções pagas, ok? Então, basicamente, se a gente for olhar aqui o Secret Manager, como o próprio nome dele sugere, ele é especializado, ele é focado no gerenciamento do ciclo de vida de um segredo. Inclusive está até aqui, né? Easily rotate, manage and retrieve secrets throughout their life cycle. Então, basicamente, ele é focado aqui nesse aspecto. Então, além de armazenar, ele também tem recursos bem avançados, né? Como a própria rotação automática, que nós também conseguimos ver que o Vault oferece. Então ele também tem essa opção. E um ponto que é muito legal do Secret Manager é o seguinte, se você estiver trabalhando com algum serviço de banco da AWS, como por exemplo o RDS, o DocumentDB, o Redshift, por exemplo, ou até mesmo algum outro banco aqui, você poderia escolher qual é o banco, você consegue aqui trabalhar com rotação. Então, por exemplo, o RDS. Aqui a gente não vai conseguir ir nessa configuração, porque eu não tenho nenhum banco, ok? Mas você já vai conseguir ali, de fato, rotacionar essa senha. Então é bem legal, você tem aqui a opção, né? O Configure Rotation. Então você consegue rotacionar aqui da maneira que você quiser, e isso daqui é muito legal, faz parte do que nós vimos ali do campo teórico do Vault, então você tem ali uma chave que ela querendo ou não pode ser vazada, mas aí você pode ter mecanismos de rotacionar isso, por exemplo, a cada deploy, ou você pode ter algum tipo de job que faz isso de tempos em tempos, e aí você garante o ciclo de vida da sua estrutura, da sua key, do seu acesso em si. Você consegue não ter aquele dado fixo, até porque às vezes, por exemplo, não é legal que o time tenha acesso ao banco de dados em produção. Então, caso essa informação vaze, por exemplo, você tem ali uma segurança de que será rotacionada em algum momento. Então, o Secret Manager, além disso, ele tem esse plus, que é justamente a parte da rotação. Você pode configurar para a chave rotacionar de tempos em tempos e ele mesmo é quem faz isso. Se a gente for trabalhar com serviços da AWS, como o RDS, o DocumentDB, que é o banco de dados aqui orientado a documentos, no SQL, e o Redshift, que é o nosso Data Lake, ou Data Warehouse aqui no caso, ele já se integra automaticamente. Então você já consegue rotacionar de uma maneira muito mais simples ali porque ele tem integração direta e independe de você fazer qualquer tipo de coisa, qualquer tipo de integração, qualquer tipo de job por fora. Beleza? Então é o primeiro ponto aqui que é bem legal. Inclusive a gente vai trabalhar um pouquinho com ele aqui de exemplo, mas esse é o grande ponto aqui do Secret Manager. Então ele não é somente de guardar a sua círculo ele também tem recursos mais avançados aqui nesse sentido beleza aqui também nós temos obviamente o preço dele né então ele também não dá para dizer que é um serviço muito barato tá então ele é basicamente 40 centavos de dólar por Secret por mês ou se você por exemplo tiver ali vamos colocar aqui 100 secrets, vamos colocar aqui um número até relativamente baixo, nós estamos falando aqui de 40 dólares por mês. Então obviamente ali vai ter esse custo, que é obviamente um custo ali exponencial. Caso você tenha também, e aí no caso você tem aqui 30 dias trial para fazer testar, e você também paga a cada 10 10 mil chamadas de API cinco centavos a cada 10 mil chamadas então isso aqui no final do dia tem um curso né se você for ali trabalhar por exemplo é com muitas chaves esse preço que ele vai crescer de maneira exponencial então é sempre um ponto importante aqui a ser lembrando beleza quando a gente fala um pouquinho do KMS né que eu tá aqui do lado, que é justamente um pouco diferente. Então ele aqui já está falando que é justamente, ele é focado para criar chaves e controlar a encriptação entre serviços AWS e muito mais. Então basicamente, como a própria explicação sugere, ele nada mais é do que um criador de chaves de criptografia que pode ser usado para a gente proteger os nossos próprios dados, né? Os dados ali das nossas aplicações, OK? Então, ele nada mais é do que uma camada ali de proteção e ele funciona como um guardião com relação às suas chaves de criptografia, OK? Então, inclusive, você pode usar o KMS também pra descriptografar. Então, por exemplo, eu tenho ali uma key que eu uso pra gerar o meu JWT. Essa aqui poderia ficar no KMS, as dentro, ok? E aí você vai ter esse controle por lá. Por enquanto aqui não é o nosso foco, ele também obviamente controla ali essa autenticação entre outros serviços também da própria AWS, ok? Então ele aqui tem algumas camadas, se a gente clicar aqui em criar chave, ele vai ter aqui opções, né? você pode falar se é uma chave simétrica, assimétrica, já no contexto mais de segurança. Se você vai querer aqui, por exemplo, encriptação e decriptação, por exemplo, se você quiser. E aí você consegue criar aqui essa estrutura. Então, basicamente, ele é isso. Ele é uma chave para assinar ali o seu dado e você consegue depois também com essa chave fazer a decriptação. Um par de chaves ali, chave pública e chave privada. Então, basicamente é isso. É um serviço ali de encriptação de chaves, ok? Das suas ali aplicações no dia a dia. Então, não é o nosso foco por hora. Eu só citei aqui porque gera essa confusão, né? Pô, tem o Circuit Manager, o KMS, tem outro aqui também. Então, por hora não é o nosso fo Mas vale a explicação, caso você queira também explorar um pouquinho, é bem interessante. A gente deve ver um pouco mais para frente essa ferramenta aqui em específico. Show? Então eu vou até fechar aqui a aba. E nós temos por último aqui o System Managers, que na verdade o System Managers aqui é uma loucura. Então ele tem um tanto de coisa, a gente vai ver aqui que tem uma pancada de opções, tem bastante coisa aqui. Mas o que a gente quer mesmo, na verdade, é isso daqui. Application Tools, ok? E aqui nós temos a opção de Parameter Store, ok? Então, é justamente o Parameter Store que seria o foco aqui. Que também é um serviço de armazenamento, ok? Então, aqui, olha só, a gente pode armazenar. Ele pode gerenciar o armazenamento de chaves e também de configurações, né? Feature Flag, por exemplo, tudo mais. Então, ele é extremamente simples, tá? O parâmetro ele estopa. E ele nada mais é do que isso. Ele faz somente isso. Ah, mas eu gostaria de ter rotação. Eu consigo? Não. Com ele, não. Ok? Você consegue basicamente armazenar as strings aqui e recuperar essas strings a nível de código. Somente isso. Beleza? Então, se a gente for aqui dar uma sintetizada, o KMS, a função principal dele é gerenciar a chave de criptografia. É isso. O Secret Manager, ele gerencia segredos e o ciclo de vida do segredo, com a parte ali de rotação. E o SSM, ele armazena a configuração. Então, ah, eu quero armazenar configurações. Eu posso usar o SSM? Pode. Ele vai atender o contexto de Secret? Vai. Eu posso colocar dados sensíveis nele? Posso. Pode. Não tem problema. O que ele não vai ter é justamente ali opções mais avançadas. Então, por exemplo, se você quiser rotacionar alguma chave aqui, é até possível, mas você vai obviamente ter que usar alguma função para fazer isso. Ou você vai ter que ter um job ou algum Lambda alguma coisa para fazer esse serviço interface a comparar meter Store com serviço que você quer rotacionar ele rotacionaria e colocaria né faria esse put dentro do paramento ele só para meter só por si só ele é muito simples ele não vai atender a esse contexto então aqui se você criar um parâmetro né ele é bem simples não tem nada demais aqui e você vai ter que o tipo, né? O que você quer? Se vai ser uma image ali, alguma coisa do EC2, se vai ser aqui uma string mesmo e é isso. Aí você cria de acordo com isso. Aqui ele já vai ter um KMS associado, tá? Que é justamente pra fazer a criptografia do dado, né? Então aqui já é um default, você poderia criar uma chave também para isso não é o caso aqui é e é isso que ele vai fazer aqui o que não tem nada demais aqui de fato né então você tem um ponto que legal que você pode falar se é uma string o céu a seguir string essa string segura ali por exemplo mas é isso não tem nenhuma opção além disso e você criou aqui o parâmetro a gente depois até faz um exemplo aqui ele passa a existir você pode recuperar ele no lado da sua aplicação. O Secret Manager é justamente isso, ele vai além. Então você cria a chave e pode criar também configurações mais avançadas aqui para entender como funciona. Beleza? Então nós aqui vamos fazer a configuração tanto de uma chave no Secret Manager e também de uma chave no Parameter Store e vamos trabalhar com isso na aplicação. Lembrando que, novamente, o mesmo que a gente viu ali, a mesma coisa que nós falamos ali no fluxo do vault, vai atender aqui também. Então aqui a gente também está nessa linha de melhorar o nosso .env quando a gente for trabalhar com o Kubernetes. Que aí a gente vai conseguir ter acesso ao conceito de sidecar e a gente vai ter ali um container que vai justamente injetar isso como envivar do lado da aplicação em tempo de subida. Então aqui por hora a gente está conhecendo muito mais o contexto em si e depois a gente obviamente vai falar mais voltado para a aplicação para fazer esses replays e até automatizar essas criações também no campo ali da aplicação. Beleza?

### Aula 2 - Configurando o SSM

é sensacional dando sequência nós vamos agora fazer a configuração inicialmente aqui do Parameter Store e na sequência a gente também volta a falar com relação ao Secret Manager Beleza então já deixei aqui inclusive aberto Olha só que interessante a lib tá então nós temos basicamente duas nós vamos instalar por enquanto a do SSM depois a gente fala um pouquinho aqui com relação ao Secret Manager então aqui nós temos o Parameter Store do System Manager ali e o Client que a gente vai utilizar é o AWS STK, livre aqui da própria AWS, do STK da AWS Client SSE. Beleza? Então para fazer aqui a instalação é bem tranquilo, então a gente vai aqui basicamente copiar este comando aqui para fazer a instalação, voltar aqui no terminal, descolar e vamos ver aqui como que nós vamos fazer a configuração. Então já foi, tudo certo, vou só fechar aqui esses arquivos ali do fluxo ainda do vault, só para organizar aqui um pouquinho meu ambiente de trabalho, vou clicar aqui no server, beleza, só para a gente ver ali. Então, e aqui ele tem basicamente a maneira com a qual a gente deveria trabalhar. E é relativamente bem simples. Reforçando aqui, eu já estou com as credenciais AWS configuradas aqui na minha máquina. Então, eu já tenho acesso à AWS. Beleza? Então, para fazer a configuração, basta a gente copiar aqui este comando do const client e vamos, por enquanto, novamente novamente colocar aqui no server.ts desta forma aqui, e a nossa region ali que nós estamos trabalhando é a us ist2, desta forma aqui, deixa eu ver se ele já vai pegar isso, beleza, então a gente vai basicamente importar, lembrando que aqui nós já estamos na versão recomendada da lib da AWS que já não é mais a nossa V2, é a V3. Então, pra buscar aqui as informações é um pouquinho diferente, tá? Isso é interessante falar. Não sei se você já trabalhou com a V2, mas aqui é um pouquinho diferente. Então, a gente basicamente tem que montar ali um comando, tá? Então, é tudo estrutura de comando. E aí, pra pegar a informação aqui vai ser o seguinte. Eu vou remover aqui o do nosso vault. Por enquanto não tem motivo de deixar aqui. Na verdade eu vou deixar, mas eu vou comentar. Fica um pouco mais simples. Vou comentar aqui. Vou comentar aqui também. Beleza. E aí para a gente pegar bastaria fazer o seguinte. Const. Vou colocar aqui const values também. Pode ser por enquanto. E vou colocar aqui const values também, pode ser por enquanto e a gente vai colocar aqui o seguinte await client .send então a gente vai enviar um comando ali para o nosso parameter store para a gente pegar o nosso resultado como a gente quer pegar alguma coisa, a gente pode usar o seguinte a gente pode abrir aqui a nossa função e colocar um new get parameter command, se eu não estou enganado alguma coisa a gente pode usar o seguinte a gente pode abrir aqui a nossa função colocar um nil get para meter como a gente se eu não tô enganado para mim ter como e aqui a gente vai passar o nome do que a gente quer enviar então aqui eu vou colocar o nome da palma aqui e colocar aqui um teste tá algo bem simples bem tranquilo desta forma e aqui nós já podemos testar, vamos testar aqui se ele pelo menos já está batendo lá na AWS então console.log balance para a gente ver se ele tem alguma coisa, obviamente ele não vai ter, mas vamos ver se ele vai ter algum erro aqui, então vamos rodar a aplicação yarn run yarn é ótimo, pnpm run deve, estou aqui acostumado com yarn mas enfim vamos aqui rodar para ver se ele tá com você tá ok e ele reclamou né Deixa eu só trocar aqui a minha versão do Node por algum motivo ele tá com 18 aqui aqui para 20 beleza então pnpm run deve eu acho que agora ele vai funcionar vamos ver, opa, ele deu o AnknowError aqui, ele deu o erro 400 então tá tranquilo, erro 400 é inclusive o esperado, tá? porque o parameter not found mas o fato é que pelo menos conectado com a AWS ele tá beleza? então, excelente, tá? pra gente aqui tá mais ou menos meio caminho andado vamos voltar aqui na na nossa AWS e vamos criar um parâmetro. Então aqui, create parameter, e vamos colocar um nome qualquer aqui. Eu vou chamar de, para ter um exemplo, lúcido, eu vou chamar de Cloudflare Access Key ID. Então está aqui. Beleza, vou colocar aqui a descrição. Descrição, chave de acesso para a Cloud alguma coisa assim tá podemos trabalhar aqui com o estandeiro não tem problema e aqui vai ser uma string segura tá então esse aqui o swing segura né vamos usar aqui o KMS tranquilo aqui tem um detalhezinho nós vamos ver ali na aplicação já já mas por enquanto é isso tá é isso, tá? E o value vai ser isso daqui, beleza? Então, tranquilo, podemos colocar aqui uma tag, eu vou colocar o IAC false, a gente está criando aqui na mão, então, vou criar aqui o parâmetro, então já está criado ali, ó, uma secure string, ok? Legal demais, tá aqui, bonitinho, né? A gente até pode ver, bonitinho né a gente até pode ver olha só mas ele fica na AWS desta forma aqui a gente pode até ver e tá lá mas ele já vai ficar aqui em criptar beleza legal e para gente buscar essa informação né como é que a gente vai fazer a gente vai buscar ali pelo nem beleza então aqui a gente vai basicamente catar o nem tá aqui ó desta forma e vamos testar aqui para ver se vai funcionar vamos ver se isso aqui vai atender o papel ele tá reclamando aqui da minha máquina deixa eu saber ficar um ponto agora ele vai ready and use show aqui um e ele sofre para ver se tem alguma coisa ou para ter que um processo que tá aberto deixa eu só matar esse processo que Kill. Vou dar aqui um kill nesse PID. Beleza. Agora eu acho que deve resolver. Vamos ver se vai. Não quer dizer que vai funcionar, mas está aqui. Então nós temos aqui o nosso valor. Olha só que legal. Então ele está aqui. Cloudflare Access Key ID. Legal demais, né? É um texto. Legal. Só que aqui tem um detalhezinho. Lembra que eu falei que a gente ia ter um detalhe? Pois é, o detalhe é este daqui. O value, ele veio fechado, tá? Então aqui na AWS, olha só que interessante. Isso aqui é muito interessante. A gente consegue ver o valor, né? Ele está aqui por padrão, é encriptado, mas a gente consegue ver. Quando a gente pega ele via API, a gente vai ter acesso a ele, mas a gente vai ter esse acesso aqui, ok? Por quê? Lembra do KMS que nós vimos na aula passada? Pois é, o KMS é quem vai decriptar essa informação aqui, ok? Então, na prática, nós precisaríamos pegar a chave ali do KMS de encript né no caso de decryptação perdão e pegar esse valor para a gente ter o acesso ao valor real o que a gente até pode fazer isso daqui mas por enquanto é só para a gente considerar e entender como funciona beleza então vai ver aqui um exemplo dessa forma e a gente vai também aproveitar e criar aqui uma um que não seria né que seria o público URL Então vamos criar também um outro exemplo para a gente ver como é que fica na AWS. Então, aqui, a gente vai criar aqui um novo parâmetro, desta forma aqui. Tranquilo demais. Então, vamos colocar aqui URL da Cloudflare. Vai ser aqui um standard mesmo, tranquilo. Só que aqui vai ser uma string, tá? Não vai ser nenhuma lista, né? separado ali por vírgula e nem também uma informação segura, tá? vai ser um texto mesmo e o value dele vai ser o que a gente definiu aqui no nosso local host, tá? então ele tá aqui tranquilo pra gente, vamos colocar aqui uma tag também com boa prática o value vai ser falso e vamos aqui criar esse parâmetro. Beleza. Então aqui, olha só. Se a gente acessar, o dado está aberto aqui pra gente. Está vendo? É um string normal. No caso aqui do primeiro parâmetro ali, ele já é um pouquinho diferente. Então ele vai ter essas propriedades mais avançadas, mas o que a gente não consegue fazer aqui, por exemplo, vai ter essas propriedades mais avançadas, mas o que a gente não consegue fazer aqui, por exemplo, é justamente a rotação desses valores. Show? Então, se a gente quiser só recuperar, a gente pode trocar aqui pelo name, colocar este name aqui, e ver ali como é que ele vai trazer para a gente. Então, ele já trouxe, está vendo? O value está aqui, então a gente vai acessar o objeto, o parameter, ponto value, e está lá o acesso. Então aqui seria .parameter .valid. Aqui obviamente é importante tipar. Então aqui no caso ele já está tipado por conta da Libre, mas você pode também criar uma tipagem sua ali para pegar de uma maneira um pouco mais simples esse valor. Então é interessante falar, mas ali localhost está certinho. Então já seria um dado para você usar e o dado passado ali ainda não. Então? Então, temos essa pendência aqui, realmente, a gente não vai ter o dado de uma maneira tão simples assim, porque a gente criou ele de maneira segura, mas a gente vai fazer aqui um breve corte e na próxima aula, só pra gente fechar aqui o assunto, porque basicamente é isso que a gente vai montar aqui no Parameter Store, a gente volta ali e faz uma pequena passada pelo KMS, só para a gente entender como é que a gente teria acesso a decriptar esse dado. A gente não vai ver como criar chaves e tudo mais, mas a gente já tem ali uma chave default, a gente vai usar essa chave para decriptar e acessar o dado, ter o dado ali aberto. Só para a gente fechar esse contexto e depois

### Aula 3 - Rápido Overview sobre o KMS

Show demais! Então, dando sequência aqui, nós vamos agora fazer uma implementação com o nosso KMS para fazer alguns testes aqui para entender melhor o que pode estar acontecendo ali na recuperação da nossa informação. Então, para a gente relembrar, de fato, nós conseguimos recuperar a informação, mas ela está encriptada. Ela está dessa forma aqui e existem duas maneiras de recuperar que a gente vai ver uma maneira que super usada e uma de uma maneira um pouco mais superficial para gente não entrar muito no detalhe Ok a primeira maneira é bem tranquila aqui no nosso Guedes para mim ter comandos a gente pode simplesmente passar uma chave e vai ser a with the Cption, ok? Então, com a decryptação, sim ou não. Se você passar aqui, por exemplo, false, não tem problema nenhum. Ele vai chegar aqui fechado, beleza? E se você quiser, você pode passar como true e aí o dado já vai chegar para a gente aberto, tá? Então, é o que nós tínhamos lá e o dado já está certinho aqui, tudo tranqu tranquilo e a outra opção é a gente usar o KMS tá e provavelmente a gente vai tomar um errinho aqui mas o KMS como que ele funciona quando a gente criou aqui a nossa chave então tá voltando aqui ó nosso nosso envivar nós passamos aqui o KMS que a gente tá vendo ele tá aqui bonitinho do SSM e é justamente ele que é responsável por encriptar a chave, então quando a gente vai decriptar a gente precisa dele quando nós passamos aqui o if decryption deixa eu só quebrar a linha aqui desse negócio um pouco mais coeso isso, beleza a gente basicamente está falando o seguinte já faz aí para mim o procedimento e está tudo certo por isso que ele já chega para a gente ali aberto. Se você quiser fazer do seu lado, você mesmo, basta usar o KMS, a lib do KMS. Então, eu vou fazer aqui uma configuração bem rapidinha, só para a gente ver o caminho, ok? Mas, usando aqui o if decryption, já vai resolver. Então, antes de mais nada, a gente criou aqui uma const client igual a SSM client o que a gente vai fazer? a gente vai renomear isso aqui pra SSM ok? desta forma aqui e a gente vai quebrar a linha aqui e colocar também o KMS e aqui nós teremos o nosso KMS client, obviamente não tem a lib ele está quebrado aqui, não vai funcionar e a gente só precisa aqui instalar a lib, que é o nosso KMS client KMS Ok então mais uma instalação aqui básica deixa eu até copiar aqui o comando do pnpm voltar aqui no nosso terminal vou sair vou entrar de novo e ele vai fazer aqui para gente instalação desse cliente beleza vou rodar aqui ele ppm run dev ele vai dar um errinho ali provavelmente nem deu na verdade, mas ok ótimo, e eu vou aqui importar porque eu não tinha na verdade salvado, por isso que ele não deu erro e aí vou importar aqui pra fazer a configuração inicial do KMS, ok? pra gente usar o KMS é muito complicado, então o que a gente vai precisar fazer aqui é basicamente deixar o dado fechado e aí a gente pode fazer o seguinte a gente vai criar aqui um const command, que eu vou inclusive chamar de value, desta forma aqui e aqui a gente vai ter um command para recuperar então este command aqui vai ser o decrypt command que é um comando aqui lembrando que as libs v3 aws são todas baseadas em comando, então aqui é um comando aqui, lembrando que as Libs V3 AWS são todas baseadas em comando, tá? Então aqui é um comando de decryptação da LibKMS, beleza? Então aqui a gente vai basicamente passar algumas informações, então a gente vai passar aqui o cipher, text blob, então aqui vamos passar um buffer, ponto from, e aqui vamos passar o nosso valor, que é o value e ponto para meter. Velho ele vai reclamar que inclusive e a gente vai passar isso como um base 64 tá então aqui a gente basicamente vai passar o nosso texto ali com um site para o nosso comando de decriptação Beleza então aqui ele vai reclamar nossa gente fazer o seguinte e esta forma aqui aí ele vai cair aqui dentro tá aí aqui a gente fazer o seguinte, if desta forma aqui, aí, ele vai cair aqui dentro, tá? E aqui a gente pode deixar ele com ok, normal, certinho, então command, beleza, acho que aqui tá ok, a gente pode aqui só colocar um const result que vai ser basicamente o await kms.send passando ali o nosso comando, tá? Ou se você quiser fazer também pode ser direto ali, que já vai funcionar. E aí pra recuperar, basta a gente ter aqui também, a gente pode passar aqui o seguinte, é comand result, e aqui embaixo a gente passa como result, que vai ser nada mais do que o decoder, né? Então new text decoder então new text decoder desta forma aqui, ponto decode, usando ali o command result command result ponto que é o que ele vai retornar pra gente ali do KMS, então é mais ou menos isso, pode ser aqui que a gente tem alguns enclaves e aí fica até dependendo como um para-caso aqui visto que não é tão tão fortemente assim o objetivo a gente vai trabalhar com o KMS um pouco mais para frente e aqui já temos a solução do próprio para meter como onde que é o outro aqui né E aí ele já vem com a decryptação que é mais um overview como a gente passou ali pelo KMS uma ver o bem básico ali só para a gente ver a nível de código. Lembrando, aqui também é legal você criar aqui na sua infra uma ws.ts, ok? Para centralizar essas configurações aqui e remover do arquivo inicial. Então, uma boa prática ali de refatoração, beleza? Então, aqui está mais ou menos ok e vamos ver se vai funcionar. Eu acredito que não, então aqui ele já falou que não vai vamos ver se vai funcionar eu acredito que não toma que ele já falou que não vai ele deu acesso negado tá e aquele deu acesso negado por quê Porque o meu usuário o meu usuário que é Ruth ele não tem autorização para decriptar nenhuma informação tá porque que isso aconteceu que a gente está usando aqui uma chave que é da própria AWS tá vendo a AWS SSM não é uma chave Nossa aqui no nosso KMS nós temos duas opções nós temos aqui a chaves que são gerenciadas ela vai ter um para cada serviço aqui vai ter um pregasse um processo e me outro para o segredo de Manager Ok para cada serviço ali do contexto de segurança com exceção aqui do EBS né enfim e nós temos também o CMK Que é o Customer Management Keys Então aqui a gente pode criar Inclusive tem aqui chaves que eu estava usando mais cedo Então a gente pode criar aqui uma chave Para ver como que isso funcionaria Então aqui, para criar, basta clicar aqui Create Key A gente vai criar aqui uma chave que ela é simétrica Então basicamente uma chave única Para fazer a encriptação e a decryptação Então se você quiser também Você então basicamente uma chave única ali para fazer a encriptação e a decryptação, ok? Então se você quiser também você pode brincar com o assimétrico, que aí você vai ter uma chave para encriptar e uma outra chave ali para fazer a decryptação, é a famosa chave pública e a chave privada, beleza? Aqui a gente vai querer uma key que ela será usada para encriptar e decryptar, aqui também tem algumas opções avançadas que não vão aqui fazer parte do nosso contexto por enquanto, vou dar aqui o next, vai pedir o nome da chave vou colocar aqui Rocket City KMS então chave usada no SSM, alguma coisa assim vou colocar uma tag também IAC false desta forma aqui, vou dar um next aqui ele vai pedir né a questão dos administradores eu por enquanto não vou configurar nada eu vou dar aqui mas ela o que é qualquer pessoa vai poder deletar essa chave então tranquilo e aqui ele vai ter os nossos usuários né então eu vou colocar aqui uma permissão para minha conta da AWS tá ela já tá aqui na verdade mas vou colocar aqui o meu account ID só para garantir a minha conta root aqui e a gente não, pelo menos, esse erro aqui nós não vamos ter mais. Lembrando que isso aqui é uma política de acesso ao recurso. Vimos muito sobre isso aqui lá no fluxo de ECS, que a gente teve que criar algumas políticas. Então, aqui ele já vai criar para a gente, mas a gente está passando algumas instruções básicas para ele. Então, next. Aqui ele vai dar mais ou menos o que eu posso fazer. Então aqui vai ter meu usuário root, pode fazer qualquer coisa no KMS. Perfeito. Então está aqui tudo certinho. Um recurso ali. Vamos finalizar. Vamos criar. Então está criado aqui o Rocketseat KMS. Está ativo. A gente até pode garantir aqui dando um enem mas tá tudo certinho beleza agora a gente vai voltar aqui no nosso SSM e a gente vai selecionar aqui ó eu já tô né então deixa eu fazer o caminho de novo a gente vai aqui na chave né do que aí de e a gente vai editar ela e vai colocar aqui Rocket City KMS então a gente vai colocar uma chave nossa ali, um KMS nossa. Vou até trocar o valor, vou colocar aqui dois cerquilhas. E aí, beleza. Vamos dar um SaveChange aqui. Beleza. Tranquilo demais. E vamos ver se vai funcionar. Eu tenho uma desconfiança que ele vai dar um errinho ali por conta do dado que a gente está usando. Ele vai reclamar que é um base64, então foi isso mesmo. Ele está reclamando aqui, ele está falando que é um invalid cipher text exception, então ele deu o erro 400 por conta aqui dessa estrutura, tá? Por conta aqui da forma que a gente está passando o buffer, provavelmente o valor que está chegando aqui é ele não estar conseguindo fazer a encriptação correta ali para passar para o comando e tá dando esse erro Ok mas aqui não tem problema né novamente aqui foi só um exemplo para que você entenda como que o carnes funciona a gente acabou inclusive tendo que criar uma chave tendo que mudar um pouquinho a estrutura então em suma isso por hora ele não vai ser objeto aqui nosso de trabalho não faz muito sentido e para a gente ter o dado aberto ali também basta passar o truco né que já vai resolver para gente aqui esse problema e aí nem precisaria olhar para o KMS nesse primeiro momento Claro ele usa o KMS por debaixo dos panos ali mas a gente nem precisa acertar com relação a ele tá e sobre aqui o nosso KMS basicamente né não tá ali no nosso contexto como eu havia comentado não é o nosso objetivo aqui aprofundar por enquanto até para não misturar muito os conhecimentos estão é só um overview bem básico para a gente entender tá se você quiser por exemplo fazer algum tipo de encriptação seria basicamente montar o comando de encrypt tá então em resumo é isso aqui foi decrypt mas poderia também ser um cripto ali de acordo com o que você quer fazer. Então, por exemplo, eu quero que a minha aplicação tenha esse contexto para fazer algumas encriptações. É possível? Sim, é possível. E aí você também trabalha com o comando, inclusive também é até uma boa prática usar o KMS para gerenciar esse contexto. Beleza? Então só para a gente fazer aquele último teste, ele já tá aqui funcionando tudo certinho, então tá tranquilo aqui com relação a implementação e tivemos também esse plus que tivemos esse probleminha, mas por não ser o foco ali também e não impactar de fato, uma vez que nós temos o próprio comando do SSM, a gente fica também como uma curiosidade caso você queira fazer a exploração ali também pode ser uma opção legal. Beleza? Então, em resumo, é isso. E agora a gente vai falar do Secret Manager. A gente vai ali entender como que ele funciona e como que a gente também cria ali as chaves e como que isso seria recuperado também no campo da aplicação.

### Aula 4 - Configurando o Secrets Manager

Sensacional! Agora nós vamos explorar um pouquinho aqui do Secret Manager e entender como que ele funciona ali na prática. Lembrando que aqui não vai ter uma grande diferença, a gente está na verdade vendo aqui algumas libs da AWS, como que elas funcionam ali. Então, vai seguir basicamente na mesma estrutura, ok? Mas o primeiro de tudo, como já estamos aqui inclusive acostumados, é justamente instalar aqui a lib do Secret Manager. Então, aqui é o default para cada recurso que você for trabalhar, que a sua aplicação for interfacial com a AWS, é uma lib apartada. Então, nós não temos mais uma lib e essa lib contém ali todos os APIs. Não, é basicamente uma lib para cada contexto. Ok? Então, opa, deixa eu eu sair aqui vamos fazer a instalação é copiei aqui o comando novamente para gente fazer a instalação excelente pnpm run deve para já deixar aqui rodando a beleza só para a gente já tem aqui o nosso contexto Beleza então é isso tá ali funcional a priori sem nenhum problema vamos voltar aqui agora e vamos basicamente criar algumas configurações então de praxe de costume nós vamos aqui quebrar a linha Ok e vamos aqui colocar o seguinte Secret Manager client Ok desta forma aqui e vamos criar como Secret Manager Ok desta forma aqui deixa eu só pode deixar na verdade não tem problema porque nós deixamos aqui o código comentado mas sem problemas então temos aqui tem a configuração do nosso cliente beleza show demais e como nós já também estamos aqui devidamente acostumados é tudo baseado em comando então para gente pegar aqui uma Secret seria algo nessa linha aqui const secret igual a await secret manager ponto, tend desta forma aqui, e o command vai ser o new podemos chamar aqui de get secret value command se eu não estou enganado, e aqui a gente vai passar também, é bem parecido inclusive com o parameter mesma coisa e aqui a gente vai passar também, né? É bem parecido, inclusive, com o Parameter, tá? Mesma coisa aqui, a gente vai passar o... Deixa eu só ver se eu fiz alguma caquinha aqui, deixa eu ver o que tá faltando... Opa, faltou um. Um aqui, beleza. Na verdade aqui não é Name, salvo engano, é SecretID. Exatamente isso. Então, secret id nós vamos ali já criar em breve. E basicamente seria a primeira configuração desta forma. A gente pode até dar um console.log aqui para ver qual vai ser o erro que a gente vai receber. Vou tirar aqui esse ponto e vírgula, que é o hábito. Então beleza, ali ele deu um problema pra gente mas erro 400, já imaginamos aqui o motivo, porque obviamente nós não temos nenhuma secret ali, ok? então vamos voltar lá na AWS vamos aqui no secret manager e vamos criar uma nova secret, então a gente vai criar aqui uma secret qualquer, ok? não é pro RDS, nós não temos inclusive nenhum banco aqui, então vou criar uma qualquer aqui e vamos colocar o seguinte vamos criar aqui a mesma chave inclusive as mesmas chaves então a gente tem aqui o close Flair e o nosso public URL então criar os dois aqui vou colocar aqui dois serquilhas é para manter aquele nosso estranho padrão e vamos colocar aqui também a nossa rota desta forma aqui beleza né E aquele vai obviamente também falar sobre a encriptação então aquele vai usar o default do seguinte maneira você pode se você quiser ali criar né gente inclusive criou aqui poderia também funcionar ali para o nosso segredo de mais por enquanto não é o caso aqui beleza então dá um next aqui beleza então o nome da Secret tá então geralmente você vai trabalhar sempre com staging prod, tá, inclusive isso também valeria pro parameter tá, geralmente quando a gente vai criar o nosso parameter a gente não vai conseguir editar o nome dele aqui mais não tem como editar o nome, mas é algo nessa mesma estrutura aqui, tá até um bom ponto ali pelo exemplo, porque aqui não tem o exemplo, mas é algo nessa linha aquiura aqui tá então bom ponto ali pelo exemplo não tem um exemplo mas é algo nessa linha aqui então seria algo como a barra em barra é o vídeo de ser né por exemplo barra o nome da sua variar tá então vem ver que obviamente seria esteja poderia ser pode poderia ser hmg né hml enfim então é mais ou menos assim a estrutura. Aqui a gente criou Ipsys Literis ali só para a gente ver o exemplo, mas a nível de boa prática, até para você segmentar entre staging e produção, seria assim. Nesse caso aqui na AWS, geralmente você tem a sua conta da AWS e ela vai obviamente atender os seus contextos de staging, os seus contextos também de produção. Então você pode no próprio name, diferente ali do vault, trabalhar com essa questão do staging prod, se você tiver ali um multi-account, aí realmente talvez também não precise, mas obviamente aqui você tem que ter o nome da aplicação, tá? Isso é um ponto importantíssimo inclusive, porque senão pode ser que outra aplicação use este campo, mas com valor diferente e você vai acabar tendo ali conflito, tá? um ponto interessante aqui vamos inclusive criar essa estrutura Então vai ser aqui no stage em barra widget server widget widget server e aqui tá ok né porque a nossa secretaria atrás ela já tem os nomes então tudo certo é chaves da aplicação widget server tá bota também importantíssimo só para ensaiar entrar aqui tudo que nós estamos fazendo aqui poderia ser feito via e a ser a gente viu ali o volume daria para usar tranquilamente aqui como nós não conhecemos ainda os recursos né fica aquela dica que eu sempre passo para gente sempre conhecer primeiro depois ele automatizar escrita mas obviamente tudo aqui você poderia fazer já com IAC. Inclusive, é a melhor prática. Beleza? IAC aqui, inclusive, falso. Não temos aqui nada de permissão diferente, nenhum tipo de replicate secret. Você poderia fazer, se você quisesse replicar para outra região, por exemplo. Não é o caso aqui. Então, next. Se você quiser rotacionar, você pode. Então, você pode falar que você quer rotacionar. Por exemplo, tem que ser pelo menos horas. Então, você pode aqui colocar, sei lá, a cada uma hora. E aí, ele vai mudar o valor. Então, isso aqui é bem interessante. Ou você pode também passar aqui uma expressão. E aí, você coloca da forma que você bem entender. Mas sempre aqui respeitando horas, dias, semanas ou meses? Minutos e segundos realmente não fazem sentido, né? Você ter uma rotação tão curta assim. Então, você poderia colocar. Eu não vou colocar aqui, tá? Mas se você quiser, você poderia. É uma opção ali interessante, beleza? Então, show. Aqui é só um review. Aqui, inclusive, ele dá um exemplo. Olha que interessante, né? Ele dá um exemplo ali de como recuperar a informação. Nós já fizemos ali mais ou menos e vamos ver se o que nós fizemos ali vai atender ou não, tá? Então, eu vou dar aqui a gente até pode ver o JavaScript, mas é mais ou menos o que nós escrevemos ali, acredito eu, tá? Não deve ter nenhuma grande diferença não, nesse sentido. Então, vou aqui dar um store beleza, opa na verdade, deixa eu ver se ele vai criar aqui, deve ter um delay. Ah, beleza, agora ele criou certinho, então aqui é uma estrutura. Nós temos a secret do widget server e dentro dela nós temos aqui basicamente, nós temos aqui alguns valores. Então são esses dois valores aqui dentro da mesma estrutura. Então aqui vai lembrar muito, de fato, o vault. É como se eu tivesse aqui um engine secret e eu criei uma pastinha staging widget server. E aqui agora a gente tem basicamente duas variáveis dentro desse contexto. Beleza? Então show! Voltando aqui para o nosso querido código, vamos ver se ele vai funcionar. Só que para isso eu tenho que passar aqui o secret ID. Então o nosso secret id aqui ele vai ser o secret name, então vamos copiar aqui o secret name, desta forma aqui, então beleza e vamos testar aqui pra ver se vai funcionar beleza, já tá aqui secret string, então tá tudo certinho então basta a gente acessar aqui o secret. secret string, então está tudo certinho, então basta a gente acessar aqui o secret.secretstring e a gente pode dar um JSON.parse dentro dessa estrutura aqui. Só ver se vai funcionar ou se vai quebrar, eu acho que ele vai reclamar ali, mas vamos ver. Ah, perfeito, já foi. Então, já recuperamos ali a nossa informação. E o grande ponto que é bem legal citar é que se, por exemplo, a sua informação for rotacionar, a sua aplicação poderia pegar isso aqui de maneira dinâmica, de acordo ali com o necessário. Então, está bem contemplado, está bem safe nesse sentido. Então, aí é basicamente isso, é bem simples aqui, não tem nenhum grande ponto, nenhum grande aspecto aqui de complexidade. E é justamente isso aqui mesmo, que é relativamente tranquilo de trabalhar. E lembra bem a estrutura do SSM, que a gente acabou inclusive falando do SSM, que daria para falar aqui também, a gente que não quis ali estender, que não é de fato o objetivo, ele entra ali num momento um pouquinho diferente. Mas é isso. E aí tudo que nós vimos lá pro Vault também acaba se aplicando aqui, tá? Então a gente pode pensar da mesma forma. Então como é que eu vou pegar isso daqui? O ideal é que você pegue na subida da aplicação. Então a gente vai ver ali Kubernetes, por exemplo, que daria pra ter um sidecar que é legal, mas também tem outras opções, né? Então, ah, eu quero, por exemplo, fazer o start agora já dessa forma. Você poderia, por exemplo, colocar aqui um shell script, fazer essa busca de informações via SH, por exemplo, e colocar isso no seu .env, então tem algumas formas, mas a gente aqui vai explorar melhor isso, de fato, ali no contexto do Kubernetes com sidecar, beleza? Então, principalmente falando do Vault, mas a gente também vai voltar aqui e falar um pouco acerca dos serviços da AWS gerenciados, inclusive a gente vai trabalhar também com o EKS da AWS então a gente vai acabar ali perpassando novamente por esses contextos então basicamente é isso fechamos aqui esse contexto de Secret, de como gerenciar melhor as nossas chaves sejam elas de fato privadas ou não. E a gente segue agora no nosso módulo um pouco mais avançado sobre Kubernetes, que a gente vai ter um bom overview sobre o contexto todo, como é que a gente sobe a aplicação do Kubernetes e tudo mais. Inclusive estou bem animado, vai ser um módulo bem legal e eu espero você lá. Um grande abraço.